<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Technology Solutions Group</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.4.3/css/foundation.min.css" integrity="" crossorigin="anonymous">
</head>

<body>

  <header class="bg-white nav-header">
    <div class="grid-container top-bar">
      <div class="top-bar-left">
        <ul class="dropdown menu flex-center-small" data-dropdown-menu>
          <li class="menuitem"><a id="branding" href="/">Technology Solutions Group</a></li>
        </ul>
      </div>

      <div class="top-bar-right">
        <ul class="menu align-center">
          <li><a href="/">Home</a></li>
          <li><a href="about.html">About</a></li>
          <li><a class="selected" href="demos.html">Demos</a></li>
        </ul>
      </div>
    </div>
  </header>

  <main id="demosPage">

    <div class="grid-container">
      <div class="grid-x align-center">
        <div id="demoRoot" class="cell small-12 medium-8">
          <article>
            <section>
              <h3>Sign in</h3>
	      <form id='loginForm'>
		<input id='username' type='text' required autocomplete='off'>
		<label>Username</label>
		<input id='password' type='password' required autocomplete='off'>
		<label>Password</label>

		<div class="formContainer">
		<button id='submitButton' type='button'>Next</button>
		</div>
	      </form>
	    </section>
          </article>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-black nav-footer">
    <ul class="menu align-center">
      <li><a href="http://www.pragmatics.com" target="_blank">Pragmatics Home</a></li>
    </ul>
  </footer>

  <script>
    const loginForm = document.getElementById('loginForm');
    const submitButton = document.getElementById('submitButton');
    const demoRoot = document.getElementById('demoRoot');

    function clickHandler(e) {
      e.preventDefault();

      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      const credentials = {
        username,
        password
      };

      const blob = new Blob([JSON.stringify(credentials, null, 2)], {type : 'application/json'});

      fetch('https://halo.pragmatics.com:8080/authenticate', {
        method : 'POST',
        //body : params
        body : blob
      })
      .then(res => {
        console.log('This is the initial resposne: ');
        console.log(res);
        return res.text();
      })
      .then(json => {
        console.log('This is the json: ');
        console.log(json);
        if (json) {
        return JSON.parse(json);
        }
      })
      .catch(err => {
        console.log('This is the error: ' + err);
      })
      .then(data => {
        console.log('This is the data being sent down: ');
        console.log(data);
        if (data) {
          const token = data.token;
          const permissions = JSON.stringify(data.permissions);

          localStorage.setItem('token', token);
          getProtectedResource(token);
        }
        else {
          localStorage.removeItem('token');
        }
      })
      .catch(err => {
        console.log('This is the error: ' + err);
      })
      .then(() => {

      });
    }

    function getProtectedResource(token) {
      const url = 'https://halo.pragmatics.com:8081/protectedResource';

      fetch(url, {
        headers : {
          'token' : token
        }
      })
      .then(res => {
        return res.text();
      })
      .catch(err => {
        //window.location.href = 'http://localhost:8080'
        demoRoot.innerHTML = 'nope';
      })
      .then(res => {
        console.log('Here is the parsed response: ');
        console.log(res);
        demoRoot.innerHTML = res;
      })
      .catch(err => {
        console.log('Caught!');
      })
    }

    submitButton.addEventListener('click', clickHandler);
  </script>

  <script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.4.3/js/foundation.min.js" integrity="" crossorigin="anonymous"></script>

</body>

</html>
